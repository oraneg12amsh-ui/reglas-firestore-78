    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Evaluación Psicológica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .screen { display: none; }
        .screen.active { display: block; }
        .answer-button, .test-choice-card, .btn-secondary, .btn-primary {
            transition: all 200ms ease-in-out;
        }
        .answer-button:hover, .test-choice-card:hover, .btn-secondary:hover, .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        .interpretation-section {
            scroll-margin-top: 20px;
            transition: all 300ms ease-in-out;
        }
        .highlight {
            background-color: #eff6ff; /* blue-50 */
            border-left: 4px solid #3b82f6; /* blue-500 */
            transform: scale(1.02);
        }
        input[type="radio"]:checked + label {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            border-color: #2563eb; /* border-blue-600 */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 500ms ease-out forwards;
        }
        /* New styles for the dashboard */
        .dashboard-container {
            min-height: 500px;
        }
        .report-list-item:hover {
            cursor: pointer;
            background-color: #f3f4f6;
        }
        .collapsible-header {
            cursor: pointer;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 flex items-center justify-center min-h-screen">
        <div id="app-container" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl transition-all duration-500">
            
            <header class="text-center p-6 border-b border-gray-200">
                <img src="https://scontent-dfw5-2.xx.fbcdn.net/v/t39.30808-6/292087515_556097079637369_460375979640215319_n.jpg?_nc_cat=106&cb=99be929b-fc739e1c&ccb=1-7&_nc_sid=6ee11a&_nc_eui2=AeGK4w8S0CGgNC07SefwbuhVRH-6A26gZgREf7oDbqBmBN_AJb1Zx_ev_AYBeaU23TCRKRZK8-VSXd5SfSBOfMh9&_nc_ohc=L9wDG3lsRGQQ7kNvwE140f9&_nc_oc=AdmpXVt71TB1lxW5D-TqO0p1-dsl4Ra_mSoZQf6R7Dv0Ot-UNyBttek3OwTS_-3m3VY&_nc_zt=23&_nc_ht=scontent-dfw5-2.xx&_nc_gid=I9W9v-8nspAKbTgDTk4lSw&oh=00_AfWKGkounlOtCu808ewzRFDPxfSxEUox_ACRq6H-L7p38A&oe=68A62C9B" alt="Logo de la Escuela" class="h-20 mx-auto mb-4">
                <div class="text-xs text-gray-600 leading-tight">
                    <p class="font-bold">SUBSECRETARÍA DE EDUCACIÓN OBLIGATORIA</p>
                    <p class="font-semibold">DIRECCIÓN GENERAL DE EDUCACIÓN BÁSICA</p>
                    <p>PRIMER NIVEL</p>
                    <p>DIRECCIÓN DE SECUNDARIAS GENERALES</p>
                    <p>SUPERVISIÓN DE ZONA 011 DE EDUCACIÓN SECUNDARIA GENERAL</p>
                </div>
                <h1 class="text-xl font-bold text-gray-800 mt-3">ESC. SEC. GRAL. “CARMEN SERDAN”</h1>
                <p class="text-sm text-gray-500">C.C.T. 21DES0125K</p>
            </header>

            <div class="p-6 md:p-8">
                <!-- Screen 1: Student Info Form -->
                <div id="student-info-screen" class="screen active">
                     <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Registro del Evaluado</h2>
                     <p class="text-center text-gray-600 mb-8">Por favor, completa tu información para comenzar.</p>
                     <div class="space-y-4">
                         <input type="text" id="student-name" placeholder="Nombre completo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                         <input type="number" id="student-age" placeholder="Edad" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                         <input type="text" id="student-grade" placeholder="Grado y grupo (Ej: 2° A)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                         <p id="student-info-error" class="text-red-500 text-sm hidden">Todos los campos son obligatorios.</p>
                         <button id="continue-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors btn-primary">Continuar</button>
                         <button id="open-dashboard-btn" class="w-full bg-gray-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors btn-secondary">Ver Gráficas por Grupo</button>
                     </div>
                </div>

                <!-- Screen 2: Welcome / Test Selection -->
                <div id="test-selection-screen" class="screen text-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Centro de Evaluación Psicológica</h2>
                    <p class="text-gray-600 mb-8">Selecciona la prueba que deseas realizar.</p>
                    <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
                        <div class="test-choice-card bg-teal-50 border border-teal-200 rounded-lg p-6 cursor-pointer" onclick="startTest('cmasr2')">
                            <h3 class="text-xl font-bold text-teal-700 mb-2">Test de Ansiedad CMASR-2</h3>
                            <p class="text-teal-600">Evalúa manifestaciones de ansiedad a través de 49 preguntas.</p>
                        </div>
                        <div class="test-choice-card bg-indigo-50 border border-indigo-200 rounded-lg p-6 cursor-pointer" onclick="startTest('rosenberg')">
                            <h3 class="text-xl font-bold text-indigo-700 mb-2">Escala de Autoestima de Rosenberg</h3>
                            <p class="text-indigo-600">Mide el sentimiento de valía personal con 10 afirmaciones.</p>
                        </div>
                        <div class="test-choice-card bg-rose-50 border border-rose-200 rounded-lg p-6 cursor-pointer" onclick="startTest('sads')">
                            <h3 class="text-xl font-bold text-rose-700 mb-2">Escala de Evitación y Angustia Social (SADS)</h3>
                            <p class="text-rose-600">Mide la ansiedad y evitación en situaciones sociales con 28 ítems.</p>
                        </div>
                        <div class="test-choice-card bg-slate-50 border border-slate-200 rounded-lg p-6 cursor-pointer" onclick="startTest('beck_sis')">
                            <h3 class="text-xl font-bold text-slate-700 mb-2">Escala de Intencionalidad Suicida de Beck</h3>
                            <p class="text-slate-600">Evalúa las características de un intento suicida a través de 15 ítems puntuables.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Screen 3: Test Runner -->
                <div id="test-screen" class="screen">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span id="test-title" class="text-xl font-bold"></span>
                            <span id="progress-text" class="text-sm font-medium text-gray-600"></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="h-2.5 rounded-full transition-all duration-300"></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg my-6 min-h-[120px] flex items-center justify-center text-center">
                        <p id="question-text" class="text-xl md:text-2xl font-medium text-gray-800"></p>
                    </div>
                    <div id="answer-options" class="grid grid-cols-1 gap-4">
                        <!-- Answer buttons/options will be generated here -->
                    </div>
                </div>

                <!-- Screen 4: Results -->
                <div id="results-screen" class="screen">
                    <div id="report-content">
                        <!-- Report content will be generated here -->
                    </div>
                    <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                        <button id="download-btn" class="w-full sm:w-auto bg-sky-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-sky-700 transition-colors">Descargar Informe (PDF)</button>
                        <button id="register-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Registrar Reporte</button>
                        <button id="restart-btn" class="w-full sm:w-auto bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors">Volver al Inicio</button>
                    </div>
                </div>

                <!-- Screen 5: Dashboard -->
                <div id="dashboard-screen" class="screen">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Panel de Gráficas por Grupo</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-6 justify-center">
                        <select id="dashboard-year" class="p-2 border border-gray-300 rounded-lg">
                            <option value="1">1° Año</option>
                            <option value="2">2° Año</option>
                            <option value="3">3° Año</option>
                        </select>
                        <select id="dashboard-group" class="p-2 border border-gray-300 rounded-lg">
                            <option value="A">Grupo A</option>
                            <option value="B">Grupo B</option>
                            <option value="C">Grupo C</option>
                            <option value="D">Grupo D</option>
                        </select>
                    </div>
                    <!-- Contenido que se va a capturar para el PDF -->
                    <div id="dashboard-report-content" class="bg-white rounded-lg shadow-md p-6 dashboard-container">
                        <p id="dashboard-report-summary" class="text-center text-lg font-semibold mb-4 hidden">Análisis del grupo: <span id="most-prevalent-test" class="font-bold text-blue-600"></span></p>
                        <div class="w-full h-[400px]"> <!-- Contenedor para la gráfica con tamaño fijo -->
                             <canvas id="dashboardChart"></canvas>
                        </div>
                        <div id="dashboard-report-list" class="mt-8">
                             <h3 id="toggle-report-list-btn" class="text-xl font-bold mb-4 collapsible-header flex justify-between items-center">
                                 <span>Reportes Registrados</span>
                                 <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-0 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
                                     <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                 </svg>
                             </h3>
                             <ul id="report-list" class="space-y-2 hidden"></ul>
                        </div>
                        <p id="dashboard-no-data" class="text-center text-gray-500 mt-4 hidden">No hay datos disponibles para este grupo.</p>
                    </div>
                    <div class="mt-6 text-center flex flex-col sm:flex-row justify-center gap-4">
                        <button id="download-dashboard-btn" class="w-full sm:w-auto bg-sky-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-sky-700 transition-colors">Descargar Gráficas (PDF)</button>
                        <button id="back-from-dashboard" class="w-full sm:w-auto bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors btn-secondary">Volver al Inicio</button>
                    </div>
                </div>
                
                <!-- Screen 6: Individual Report Viewer -->
                <div id="individual-report-screen" class="screen">
                    <div id="individual-report-content">
                        <!-- Reporte individual se genera aquí -->
                    </div>
                    <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                         <button id="download-individual-btn" class="w-full sm:w-auto bg-sky-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-sky-700 transition-colors">Descargar Informe (PDF)</button>
                         <button id="back-to-dashboard-btn" class="w-full sm:w-auto bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors">Volver al Panel</button>
                    </div>
                </div>

                <!-- Modal para errores y mensajes -->
                <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-auto text-center">
                        <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
                        <p id="modal-text" class="mb-6 text-gray-700"></p>
                        <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">Entendido</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL STATE ---
        let db, auth, userId;
        let currentTestKey = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let studentData = {};
        let chartInstance = null;
        let dashboardChartInstance = null;
        let testScores = {}; 
        let reportTimestamp = null;
        const { jsPDF } = window.jspdf;
        
        // --- DOM ELEMENTS ---
        const screens = {
            studentInfo: document.getElementById('student-info-screen'),
            testSelection: document.getElementById('test-selection-screen'),
            test: document.getElementById('test-screen'),
            results: document.getElementById('results-screen'),
            dashboard: document.getElementById('dashboard-screen'),
            individualReport: document.getElementById('individual-report-screen')
        };
        const appContainer = document.getElementById('app-container');
        const testTitle = document.getElementById('test-title');
        const questionText = document.getElementById('question-text');
        const answerOptionsContainer = document.getElementById('answer-options');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const downloadBtn = document.getElementById('download-btn');
        const registerBtn = document.getElementById('register-btn');
        const restartBtn = document.getElementById('restart-btn');
        const reportContent = document.getElementById('report-content');
        const continueBtn = document.getElementById('continue-btn');
        const openDashboardBtn = document.getElementById('open-dashboard-btn');
        const dashboardYearSelect = document.getElementById('dashboard-year');
        const dashboardGroupSelect = document.getElementById('dashboard-group');
        const dashboardChartEl = document.getElementById('dashboardChart');
        const dashboardNoDataEl = document.getElementById('dashboard-no-data');
        const backFromDashboardBtn = document.getElementById('back-from-dashboard');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const dashboardReportSummaryEl = document.getElementById('dashboard-report-summary');
        const mostPrevalentTestEl = document.getElementById('most-prevalent-test');
        const downloadDashboardBtn = document.getElementById('download-dashboard-btn');
        const dashboardReportContent = document.getElementById('dashboard-report-content');
        const reportListEl = document.getElementById('report-list');
        const individualReportContentEl = document.getElementById('individual-report-content');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const downloadIndividualBtn = document.getElementById('download-individual-btn');
        const toggleReportListBtn = document.getElementById('toggle-report-list-btn');
        const toggleIcon = document.getElementById('toggle-icon');

        // --- FIREBASE INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        let authReady = false;

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Usuario autenticado con UID:", userId);
                    authReady = true;
                } else {
                    console.log("Iniciando sesión de forma anónima...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error al iniciar sesión:", error);
                    }
                }
            });
        } else {
            console.error("Falta la configuración de Firebase. No se pueden usar las funciones de la base de datos.");
            registerBtn.classList.add('hidden');
            openDashboardBtn.classList.add('hidden');
        }

        function showMessage(title, message, isError = false) {
            modalTitle.textContent = title;
            modalText.textContent = message;
            const modalBtn = document.querySelector('#message-modal button');
            if (isError) {
                modalTitle.classList.add('text-red-600');
                modalTitle.classList.remove('text-green-600');
                modalBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                modalBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            } else {
                modalTitle.classList.add('text-green-600');
                modalTitle.classList.remove('text-red-600');
                modalBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                modalBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            }
            messageModal.classList.remove('hidden');
        }

        // --- TEST DEFINITIONS ---
        const tests = {
            cmasr2: {
                title: "Test de Ansiedad CMASR-2",
                questions: [
                    { text: "Muchas veces siento asco o náuseas.", scale: 'fis' }, { text: "Soy muy nervioso(a).", scale: 'inq' }, { text: "Muchas veces me preocupa que algo malo me pase.", scale: 'inq' }, { text: "Tengo miedo que otros niños se rían de mí durante la clase.", scale: 'soc' }, { text: "Tengo demasiados dolores de cabeza.", scale: 'fis' }, { text: "Me preocupa no agradarle a los otros.", scale: 'inq' }, { text: "Algunas veces me despierto asustado(a).", scale: 'fis' }, { text: "La gente me pone nervioso(a).", scale: 'inq' }, { text: "Siento que alguien va a decirme que hago mal las cosas.", scale: 'soc' }, { text: "Tengo miedo que los demás se rían de mí.", scale: 'soc' }, { text: "Me cuesta trabajo tomar decisiones.", scale: 'fis' }, { text: "Me pongo nervioso(a) cuando las cosas no me salen como quiero.", scale: 'inq' }, { text: "Parece que las cosas son más fáciles para los demás que para mí.", scale: 'soc' }, { text: "Todas las personas que conozco me caen bien.", scale: 'def' }, { text: "Muchas veces siento que me falta el aire.", scale: 'fis' }, { text: "Casi todo el tiempo estoy preocupado(a).", scale: 'inq' }, { text: "Me siento mal si la gente se ríe de mí.", scale: 'soc' }, { text: "Muchas cosas me dan miedo.", scale: 'inq' }, { text: "Siempre soy amable.", scale: 'def' }, { text: "Me enojo con facilidad.", scale: 'fis' }, { text: "Me preocupa lo que mis papás me vayan a decir.", scale: 'inq' }, { text: "Me siento que a los demás no les gusta cómo hago las cosas.", scale: 'soc' }, { text: "Me da miedo hablar en voz alta ante mis compañeros durante la clase.", scale: 'soc' }, { text: "Siempre me porto bien.", scale: 'def' }, { text: "En las noches me cuesta trabajo quedarme dormido(a).", scale: 'fis' }, { text: "Me preocupa lo que la gente piense de mí.", scale: 'inq' }, { text: "Me siento solo(a) aunque esté acompañado(a).", scale: 'soc' }, { text: "En la escuela se burlan de mí.", scale: 'soc' }, { text: "Siempre soy bueno(a).", scale: 'def' }, { text: "Es muy fácil herir mis sentimientos.", scale: 'inq' }, { text: "Me sudan las manos.", scale: 'fis' }, { text: "Me preocupa cometer errores delante de la gente.", scale: 'inq' }, { text: "Siempre soy agradable con todos.", scale: 'def' }, { text: "Me canso mucho.", scale: 'fis' }, { text: "Me preocupa lo que va a pasar.", scale: 'inq' }, { text: "Los demás son más felices que yo.", scale: 'soc' }, { text: "Temo hablar en voz alta delante de un grupo.", scale: 'soc' }, { text: "Siempre digo la verdad.", scale: 'def' }, { text: "Tengo pesadillas.", scale: 'fis' }, { text: "A veces me enojo.", scale: 'def', reverse: true }, { text: "Me preocupa que durante la clase me hagan participar.", scale: 'soc' }, { text: "Me siento preocupado(a) cuando me voy a dormir en la noche.", scale: 'inq' }, { text: "Me cuesta trabajo concentrarme en mis tareas escolares.", scale: 'fis' }, { text: "A veces digo cosas que no debería decir.", scale: 'def', reverse: true }, { text: "Me preocupa que alguien me dé una golpiza.", scale: 'inq' }, { text: "Me muevo mucho en mi asiento.", scale: 'fis' }, { text: "Muchas personas están en mi contra.", scale: 'soc' }, { text: "He dicho alguna mentira.", scale: 'def', reverse: true }, { text: "Me preocupa decir alguna tontería.", scale: 'inq' }
                ],
                options: [{ text: "Sí", value: true }, { text: "No", value: false }],
                incPairs: [[2,8], [3,35], [4,10], [6,49], [7,39], [19,33], [23,37], [24,29], [38,48]],
                progressBarColor: 'bg-teal-500'
            },
            rosenberg: {
                title: "Escala de Autoestima de Rosenberg",
                questions: [
                    { text: "Siento que soy una persona digna de aprecio, al menos en igual medida que los demás.", positive: true }, { text: "Estoy convencido de que tengo buenas cualidades.", positive: true }, { text: "Soy capaz de hacer las cosas tan bien como la mayoría de la gente.", positive: true }, { text: "Tengo una actitud positiva hacia mí mismo.", positive: true }, { text: "En general, estoy satisfecho conmigo mismo.", positive: true }, { text: "Siento que no tengo mucho de lo que estar orgulloso.", positive: false }, { text: "En general, me inclino a pensar que soy un fracasado.", positive: false }, { text: "Me gustaría poder sentir más respeto por mí mismo.", positive: false }, { text: "A veces me siento verdaderamente inútil.", positive: false }, { text: "A veces pienso que no soy bueno para nada.", positive: false }
                ],
                options: [
                    { text: "Muy de acuerdo", value: 3 }, { text: "De acuerdo", value: 2 }, { text: "En desacuerdo", value: 1 }, { text: "Muy en desacuerdo", value: 0 }
                ],
                progressBarColor: 'bg-indigo-500'
            },
            sads: {
                title: "Escala de Evitación y Angustia Social (SADS)",
                questions: [
                    { text: "Me siento relajado incluso en situaciones sociales poco familiares.", scoringKey: false }, { text: "Trato de evitar situaciones que me obliguen a ser muy sociable.", scoringKey: true }, { text: "Me resulta fácil relajarme cuando estoy con otras personas.", scoringKey: false }, { text: "Prefiero estar solo que con otras personas.", scoringKey: false }, { text: "Normalmente me siento tranquilo y cómodo en situaciones sociales.", scoringKey: true }, { text: "Me siento incómodo en reuniones formales.", scoringKey: false }, { text: "Generalmente estoy tranquilo cuando estoy con otras personas.", scoringKey: false }, { text: "Trato de evitar hablar con la gente a menos que los conozca bien.", scoringKey: true }, { text: "Si tengo la oportunidad de conocer gente nueva, la aprovecho.", scoringKey: true }, { text: "A menudo me siento nervioso o tenso en reuniones casuales con otras personas.", scoringKey: true }, { text: "Generalmente me siento incómodo con otras personas.", scoringKey: false }, { text: "Me pongo nervioso si tengo que hablar delante de un grupo pequeño.", scoringKey: true }, { text: "A menudo salgo de mi camino para evitar conocer gente nueva.", scoringKey: false }, { text: "Me siento inhibido en situaciones sociales.", scoringKey: true }, { text: "Me cuesta pensar en algo que decir a la mayoría de la gente.", scoringKey: true }, { text: "A menudo me siento ansioso en reuniones sociales.", scoringKey: true }, { text: "Me resulta difícil mezclarme con un grupo de personas.", scoringKey: false }, { text: "A menudo estoy nervioso cuando estoy en un grupo de personas.", scoringKey: false }, { text: "A menudo me siento cohibido en situaciones sociales.", scoringKey: true }, { text: "Me resulta fácil pensar en cosas de las que hablar.", scoringKey: false }, { text: "Me preocupa sentirme avergonzado en situaciones sociales.", scoringKey: true }, { text: "Me siento cómodo con la gente.", scoringKey: true }, { text: "Me siento tenso cuando estoy con gente que no conozco bien.", scoringKey: false }, { text: "Me resulta fácil hablar con extraños.", scoringKey: false }, { text: "A menudo me siento nervioso al hablar con alguien de autoridad.", scoringKey: true }, { text: "Me siento más cómodo en una situación social que la mayoría de la gente.", scoringKey: true }, { text: "Me resulta difícil relajarme cuando estoy con un grupo de personas.", scoringKey: false }, { text: "A menudo deseo ser más sociable.", scoringKey: true }
                ],
                options: [{ text: "Verdadero", value: true }, { text: "Falso", value: false }],
                progressBarColor: 'bg-rose-500'
            },
            beck_sis: {
                title: "Escala de Intencionalidad Suicida de Beck",
                questions: [
                    { text: "Aislamiento:", options: ["Alguien presente", "Alguien próximo o en contacto", "Nadie cerca o en contacto"] },
                    { text: "Medición del tiempo:", options: ["Intervención muy probable", "Intervención poco probable", "Intervención altamente improbable"] },
                    { text: "Precauciones contra el descubrimiento:", options: ["Ninguna", "Precauciones pasivas (ej. evitar a otros)", "Precauciones activas (ej. cerrar puerta)"] },
                    { text: "Actuación para conseguir ayuda:", options: ["Avisó a alguien", "Colaborador potencial contactado, no avisado", "No contactó, ni avisó a nadie"] },
                    { text: "Actos finales (legado, testamento):", options: ["Ninguno", "Preparación parcial", "Planes definitivos o terminados"] },
                    { text: "Preparación activa del intento:", options: ["Ninguna", "Mínima o moderada", "Importante"] },
                    { text: "Nota suicida:", options: ["Ninguna", "Nota escrita pero rota, pensó escribirla", "Presencia de nota"] },
                    { text: "Comunicación verbal:", options: ["No comunicación verbal", "Comunicación ambigua", "Comunicación no ambigua"] },
                    { text: "Propósito supuesto del intento:", options: ["Manipular a otros, conseguir atención", "Componentes mixtos", "Escapar de la vida, solución irreversible"] },
                    { text: "Expectativas sobre la probabilidad de muerte:", options: ["Pensó que era improbable", "Posible, pero no probable", "Probable o cierta"] },
                    { text: "Concepción de la letalidad del método:", options: ["Menos de lo que pensaba que sería letal", "No estaba seguro si era letal", "Igualó o excedió lo que pensaba mortal"] },
                    { text: "Seriedad del intento:", options: ["No intentó seriamente morir", "Inseguro", "Intentó seriamente morir"] },
                    { text: "Actitud ante el vivir / morir:", options: ["No quería morir", "Componentes mixtos", "Quería morir"] },
                    { text: "Capacidad de salvamento médico:", options: ["Muerte improbable con atención médica", "Inseguro si la atención médica ayudaría", "Seguro de morir aunque recibiese atención"] },
                    { text: "Grado de premeditación:", options: ["Ninguno, impulsivo", "Contemplado < 3 horas antes", "Contemplado > 3 horas antes"] }
                ],
                 progressBarColor: 'bg-slate-500'
            }
        };

        // --- CORE FUNCTIONS ---
        function showScreen(screen) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            appContainer.classList.remove('max-w-2xl', 'max-w-4xl');
            if (screen === screens.results || screen === screens.dashboard || screen === screens.individualReport) {
                appContainer.classList.add('max-w-4xl');
            } else {
                appContainer.classList.add('max-w-2xl');
            }
            screen.classList.add('active');
        }

        function saveStudentInfoAndProceed() {
            const name = document.getElementById('student-name').value;
            const age = document.getElementById('student-age').value;
            const grade = document.getElementById('student-grade').value.toUpperCase().replace(/\s/g, ''); 
            const errorEl = document.getElementById('student-info-error');

            if (!name || !age || !grade) {
                errorEl.classList.remove('hidden');
                return;
            }
            errorEl.classList.add('hidden');
            
            const gradeRegex = /^[1-3][A-D]$/;
            if (!gradeRegex.test(grade)) {
                showMessage('Error de Formato', 'Por favor, ingrese el grado y grupo en el formato correcto (ej: 2A, 3B).');
                return;
            }

            studentData = { 
                name, 
                age: parseInt(age), 
                grade,
                year: parseInt(grade.charAt(0)),
                group: grade.charAt(1)
            };
            showScreen(screens.testSelection);
        }
        
        window.startTest = (testKey) => {
            currentTestKey = testKey;
            currentQuestionIndex = 0;
            userAnswers = new Array(tests[currentTestKey].questions.length).fill(null);
            testTitle.textContent = tests[currentTestKey].title;
            progressBar.className = `h-2.5 rounded-full transition-all duration-300 ${tests[currentTestKey].progressBarColor}`;
            displayQuestion();
            showScreen(screens.test);
        }

        function displayQuestion() {
            const test = tests[currentTestKey];
            const question = test.questions[currentQuestionIndex];
            
            questionText.textContent = `${currentQuestionIndex + 1}. ${question.text}`;
            
            answerOptionsContainer.innerHTML = '';
            if (currentTestKey === 'cmasr2' || currentTestKey === 'sads') {
                answerOptionsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                const trueText = currentTestKey === 'cmasr2' ? 'Sí' : 'Verdadero';
                const falseText = currentTestKey === 'cmasr2' ? 'No' : 'Falso';
                answerOptionsContainer.innerHTML = `
                    <button class="answer-button w-full bg-green-500 text-white font-bold py-4 px-6 rounded-lg hover:bg-green-600" data-answer="true">${trueText}</button>
                    <button class="answer-button w-full bg-red-500 text-white font-bold py-4 px-6 rounded-lg hover:bg-red-600" data-answer="false">${falseText}</button>
                `;
                answerOptionsContainer.querySelectorAll('.answer-button').forEach(btn => {
                    btn.onclick = () => handleAnswer(btn.dataset.answer === 'true');
                });
            } else if (currentTestKey === 'rosenberg' || currentTestKey === 'beck_sis') {
                 answerOptionsContainer.className = 'grid grid-cols-1 gap-3';
                 const options = currentTestKey === 'rosenberg' ? tests.rosenberg.options : question.options.map((text, i) => ({ text, value: i }));
                 options.forEach(choice => {
                    const button = document.createElement('button');
                    button.textContent = choice.text;
                    button.dataset.value = choice.value;
                    button.className = 'answer-button w-full border-2 border-gray-300 text-gray-700 font-semibold py-3 px-5 rounded-lg hover:bg-gray-100';
                    if (userAnswers[currentQuestionIndex] === choice.value) {
                        button.classList.add('selected');
                    }
                    button.onclick = () => handleAnswer(choice.value);
                    answerOptionsContainer.appendChild(button);
                });
            }
            updateProgress();
        }

        function handleAnswer(answer) {
            userAnswers[currentQuestionIndex] = answer;
            currentQuestionIndex++;
            if (currentQuestionIndex < tests[currentTestKey].questions.length) {
                displayQuestion();
            } else {
                showResults();
            }
        }

        function updateProgress() {
            const test = tests[currentTestKey];
            const progress = ((currentQuestionIndex) / test.questions.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Pregunta ${currentQuestionIndex} / ${test.questions.length}`;
        }

        function showResults() {
            if (userAnswers.includes(null)) {
                showMessage('Atención', 'Por favor, responde todas las preguntas para poder generar tu reporte.', true);
                currentQuestionIndex = userAnswers.findIndex(answer => answer === null);
                displayQuestion();
                return;
            }

            reportTimestamp = new Date().toISOString();
            
            if (currentTestKey === 'cmasr2') {
                testScores = calculateCMASR2Scores();
            } else if (currentTestKey === 'rosenberg') {
                testScores = { score: calculateRosenbergScore() };
            } else if (currentTestKey === 'sads') {
                testScores = { score: calculateSADSScore() };
            } else if (currentTestKey === 'beck_sis') {
                testScores = { score: calculateBeckSISScore() };
            }
            
            reportContent.innerHTML = generateReportContent({ student: studentData, testKey: currentTestKey, scores: testScores, timestamp: reportTimestamp, answers: JSON.stringify(userAnswers) });
            if (currentTestKey === 'cmasr2') {
                 populateCMASR2Interpretations({ scores: testScores, container: reportContent });
                 const { tScores } = testScores;
                 const scoreData = { labels: ['A. Fisiológica', 'Inquietud', 'A. Social', 'A. Total'], tScores: [tScores.fis, tScores.inq, tScores.soc, tScores.tot], ids: ['fis', 'inq', 'soc', 'tot'] };
                 const ctx = reportContent.querySelector('#resultsChart').getContext('2d');
                 if (chartInstance) chartInstance.destroy();
                 chartInstance = new Chart(ctx, { type: 'bar', data: { labels: scoreData.labels, datasets: [{ label: 'Puntuación T', data: scoreData.tScores, backgroundColor: scoreData.tScores.map(score => score > 70 ? 'rgba(239, 68, 68, 0.6)' : score > 60 ? 'rgba(251, 191, 36, 0.6)' : 'rgba(20, 184, 166, 0.6)'), borderColor: scoreData.tScores.map(score => score > 70 ? 'rgba(185, 28, 28, 1)' : score > 60 ? 'rgba(217, 119, 6, 1)' : 'rgba(13, 148, 136, 1)'), borderWidth: 2, borderRadius: 5 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 80, title: { display: true, text: 'Puntuación T' } } }, plugins: { legend: { display: false } }, onClick: (event, elements) => { if (elements.length > 0) { const targetId = scoreData.ids[elements[0].index]; const section = document.getElementById(`interp-${targetId}`); if (section) { document.querySelectorAll('.interpretation-section').forEach(el => el.classList.remove('highlight')); section.classList.add('highlight'); section.scrollIntoView({ behavior: 'smooth', block: 'center' }); } } }, onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; } } });
            }

            showScreen(screens.results);
        }

        function generateReportContent(report) {
            const testKey = report.testKey;
            const test = tests[testKey];
            const scores = report.scores;
            const student = report.student;
            const answers = JSON.parse(report.answers);
            const formattedDate = new Date(report.timestamp).toLocaleString('es-MX', { dateStyle: 'full', timeStyle: 'short'});

            let reportHtml = ``;
            
            if (testKey === 'cmasr2') {
                const { tScores, incScore } = scores;
                reportHtml = `<header class="text-center mb-8"><h1 class="text-3xl md:text-4xl font-bold text-teal-800">Informe de Resultados: CMASR-2</h1><div class="text-md text-stone-600 mt-4 grid grid-cols-3 gap-4"><p><strong>Nombre:</strong> ${student.name}</p><p><strong>Edad:</strong> ${student.age}</p><p><strong>Grado:</strong> ${student.grade}</p></div><p class="text-sm text-gray-500 mt-2"><strong>Fecha de Registro:</strong> ${formattedDate}</p></header><section class="mb-8"><h2 class="text-2xl font-semibold text-teal-700 mb-4 border-b pb-2">Validez del Perfil</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center"><div class="bg-green-50 border border-green-200 rounded-lg p-5"><h3 class="text-lg font-semibold text-green-700">Índice de Inconsistencia (INC)</h3><p class="text-5xl font-bold text-green-800">${incScore}</p><p class="text-sm text-green-600 mt-1">${incScore < 6 ? '(Protocolo Válido)' : '(Protocolo Inválido)'}</p></div><div class="bg-stone-50 border border-stone-200 rounded-lg p-5"><h3 class="text-lg font-semibold text-stone-700">Defensividad (DEF)</h3><p class="text-5xl font-bold text-stone-800">T=${tScores.def}</p><p class="text-sm text-stone-600 mt-1">${tScores.def < 60 ? '(Respuesta Sincera)' : '(Posible Defensividad)'}</p></div></div></section><section class="mb-8"><h2 class="text-2xl font-semibold text-teal-700 mb-4 border-b pb-2">Visualización de Escalas</h2><div class="relative w-full max-w-2xl mx-auto h-96"><canvas id="resultsChart"></canvas></div></section><section><h2 class="text-2xl font-semibold text-teal-700 mb-4 border-b pb-2">Análisis Detallado</h2><div class="space-y-6"><div id="interp-tot" class="interpretation-section p-5 rounded-lg border bg-stone-50"></div><div id="interp-fis" class="interpretation-section p-5 rounded-lg border bg-stone-50"></div><div id="interp-inq" class="interpretation-section p-5 rounded-lg border bg-stone-50"></div><div id="interp-soc" class="interpretation-section p-5 rounded-lg border bg-stone-50"></div></div></section>`;
                let detailedAnswersHTML = `<section class="mt-8"><h2 class="text-2xl font-semibold text-teal-700 mb-4 border-b pb-2">Respuestas Detalladas</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-sm">`;
                
                test.questions.forEach((q, index) => {
                    const answer = answers[index] ? 'Sí' : 'No';
                    const answerColor = answers[index] ? 'text-red-600 font-bold' : 'text-green-700';
                    detailedAnswersHTML += `<div class="flex justify-between border-b py-1"><p class="text-gray-600">${q.text}</p><p class="${answerColor}">${answer}</p></div>`;
                });
                detailedAnswersHTML += `</div></section>`;
                
                return `${reportHtml}${detailedAnswersHTML}`;

            } else if (testKey === 'rosenberg') {
                const score = scores.score;
                let level, interpretation, scoreColor, levelColor;
                if (score >= 30) { level = "Autoestima Elevada (Normal)"; interpretation = "Tu resultado sugiere que tienes una percepción positiva y saludable de ti mismo/a. Generalmente, te sientes una persona valiosa y digna de aprecio. Mantienes una actitud de confianza en tus propias capacidades y te sientes satisfecho/a contigo en general. Este es un indicador de un buen bienestar emocional."; scoreColor = 'text-green-600'; levelColor = 'text-green-700'; } else if (score >= 26) { level = "Autoestima Media"; interpretation = "Tu puntuación indica un nivel de autoestima adecuado, aunque con algunas áreas de mejora. Es posible que, aunque generalmente te valores positivamente, en ocasiones dudes de tus capacidades o te sientas insatisfecho/a. No representa un problema grave, pero fortalecer tu autoconcepto y autoaceptación podría incrementar tu bienestar general."; scoreColor = 'text-yellow-600'; levelColor = 'text-yellow-700'; } else { level = "Autoestima Baja"; interpretation = "Un puntaje en este rango sugiere la presencia de problemas significativos de autoestima. Es probable que frecuentemente te sientas insatisfecho/a contigo mismo/a, dudes de tu propio valor y te percibas de manera negativa. Sería beneficioso explorar estos sentimientos, ya sea a través de la auto-reflexión o buscando el apoyo de un profesional para fortalecer tu amor propio y confianza."; scoreColor = 'text-red-600'; levelColor = 'text-red-700'; }

                let detailedAnswersHTML = `<section class="mt-8"><h2 class="text-2xl font-semibold text-indigo-700 mb-4 border-b pb-2">Respuestas Detalladas</h2><div class="space-y-2 text-sm">`;
                const answerMap = { 3: "Muy de acuerdo", 2: "De acuerdo", 1: "En desacuerdo", 0: "Muy en desacuerdo" };
                test.questions.forEach((q, index) => { const answerText = answerMap[answers[index]]; detailedAnswersHTML += `<div class="flex justify-between border-b py-1"><p class="text-gray-600">${index + 1}. ${q.text}</p><p class="font-semibold text-gray-800">${answerText}</p></div>`; });
                detailedAnswersHTML += `</div></section>`;
                return `<header class="text-center mb-8"><h1 class="text-3xl font-bold text-indigo-800">Resultados del Test de Autoestima</h1><div class="text-md text-stone-600 mt-4 grid grid-cols-3 gap-4"><p><strong>Nombre:</strong> ${student.name}</p><p><strong>Edad:</strong> ${student.age}</p><p><strong>Grado:</strong> ${student.grade}</p></div><p class="text-sm text-gray-500 mt-2"><strong>Fecha de Registro:</strong> ${formattedDate}</p></header><div class="bg-gray-50 border border-gray-200 rounded-lg p-8 my-8 text-center"><p class="text-lg text-gray-700">Tu puntuación es:</p><p class="text-7xl font-bold my-4 ${scoreColor}">${score}</p><p class="text-2xl font-semibold mb-2 ${levelColor}">${level}</p><p class="text-gray-600 max-w-md mx-auto">${interpretation}</p></div>${detailedAnswersHTML}`;
            } else if (testKey === 'sads') {
                const score = scores.score;
                let level, interpretation, scoreColor, levelColor;
                if (score > 14) { level = "Angustia Social Alta"; interpretation = "Un resultado en este rango sugiere un nivel significativo de angustia y/o evitación social, lo cual es altamente consistente con las características de la fobia social. Es muy recomendable buscar una evaluación diagnóstica completa por parte de un profesional de la salud mental."; scoreColor = 'text-red-600'; levelColor = 'text-red-700'; } else if (score > 7) { level = "Angustia Social Moderada"; interpretation = "Este resultado indica la presencia de algunos rasgos de angustia y/o evitación social. Dentro de los puntos de corte de la escala, este rango puede ser sugestivo de fobia social, especialmente cuando se utiliza como herramienta de cribado (screening). Se podría beneficiar de una exploración más profunda con un profesional."; scoreColor = 'text-yellow-600'; levelColor = 'text-yellow-700'; } else { level = "Angustia Social Baja"; interpretation = "Este resultado sugiere un nivel bajo o nulo de angustia y evitación en situaciones sociales, según los parámetros de esta escala. Generalmente, no se observan indicadores significativos de fobia social."; scoreColor = 'text-green-600'; levelColor = 'text-green-700'; }
                
                let detailedAnswersHTML = `<section class="mt-8"><h2 class="text-2xl font-semibold text-rose-700 mb-4 border-b pb-2">Respuestas Detalladas</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-sm">`;
                test.questions.forEach((q, index) => { const answer = answers[index] ? 'Verdadero' : 'Falso'; detailedAnswersHTML += `<div class="flex justify-between border-b py-1"><p class="text-gray-600">${index + 1}. ${q.text}</p><p class="font-semibold text-gray-800">${answer}</p></div>`; });
                detailedAnswersHTML += `</div></section>`;
                return `<header class="text-center mb-8"><h1 class="text-3xl font-bold text-rose-800">Resultados de la Escala SADS</h1><div class="text-md text-stone-600 mt-4 grid grid-cols-3 gap-4"><p><strong>Nombre:</strong> ${student.name}</p><p><strong>Edad:</strong> ${student.age}</p><p><strong>Grado:</strong> ${student.grade}</p></div><p class="text-sm text-gray-500 mt-2"><strong>Fecha de Registro:</strong> ${formattedDate}</p></header><div class="bg-gray-50 border border-gray-200 rounded-lg p-8 my-8 text-center"><p class="text-lg text-gray-700">Tu puntuación es:</p><p class="text-7xl font-bold my-4 ${scoreColor}">${score}</p><p class="text-2xl font-semibold mb-2 ${levelColor}">${level}</p><p class="text-gray-600 max-w-md mx-auto">${interpretation}</p></div>${detailedAnswersHTML}`;
            } else if (testKey === 'beck_sis') {
                const score = scores.score;
                let level, interpretation, scoreColor, levelColor;
                if (score > 15) { level = "Intencionalidad Alta"; interpretation = "Una puntuación alta indica que las características del intento reflejan una elevada seriedad y deseo de morir. Es crucial una evaluación profesional inmediata para valorar el riesgo subsecuente y establecer un plan de seguridad."; scoreColor = 'text-red-600'; levelColor = 'text-red-700'; }
                else if (score > 5) { level = "Intencionalidad Moderada"; interpretation = "La puntuación sugiere una seriedad moderada en la intencionalidad del acto. Hay indicadores significativos de deseo de morir, aunque pueden existir factores ambivalentes. Se recomienda una evaluación clínica para comprender el contexto y el riesgo futuro."; scoreColor = 'text-yellow-600'; levelColor = 'text-yellow-700'; }
                else { level = "Intencionalidad Baja"; interpretation = "La puntuación sugiere que la intencionalidad suicida durante el intento fue baja. Es posible que el acto estuviera más relacionado con el deseo de comunicar malestar que con un deseo definitivo de morir. Aun así, todo intento debe ser tomado en serio y evaluado por un profesional."; scoreColor = 'text-green-600'; levelColor = 'text-green-700'; }
                
                let detailedAnswersHTML = `<section class="mt-8"><h2 class="text-2xl font-semibold text-slate-700 mb-4 border-b pb-2">Respuestas Detalladas</h2><div class="space-y-2 text-sm">`;
                test.questions.forEach((q, index) => {
                    const answerText = q.options[answers[index]];
                    detailedAnswersHTML += `<div class="flex justify-between border-b py-1"><p class="text-gray-600">${index + 1}. ${q.text}</p><p class="font-semibold text-gray-800 text-right">${answerText}</p></div>`;
                });
                detailedAnswersHTML += `</div></section>`;
                return `<header class="text-center mb-8"><h1 class="text-3xl font-bold text-slate-800">Resultados de la Escala de Intencionalidad Suicida</h1><div class="text-md text-stone-600 mt-4 grid grid-cols-3 gap-4"><p><strong>Nombre:</strong> ${student.name}</p><p><strong>Edad:</strong> ${student.age}</p><p><strong>Grado:</strong> ${student.grade}</p></div><p class="text-sm text-gray-500 mt-2"><strong>Fecha de Registro:</strong> ${formattedDate}</p></header><div class="bg-gray-50 border border-gray-200 rounded-lg p-8 my-8 text-center"><p class="text-lg text-gray-700">Puntuación Total:</p><p class="text-7xl font-bold my-4 ${scoreColor}">${score}</p><p class="text-2xl font-semibold mb-2 ${levelColor}">${level}</p><p class="text-gray-600 max-w-md mx-auto">${interpretation}</p></div><div class="mt-8 text-center text-sm text-red-700 bg-red-50 p-4 rounded-lg border border-red-200"><strong>Descargo de Responsabilidad Importante:</strong> Esta escala evalúa las circunstancias de un <strong>intento de suicidio pasado</strong> y no predice el futuro. Si estás teniendo pensamientos de hacerte daño ahora, busca ayuda profesional de inmediato.</div>${detailedAnswersHTML}`;
            }
        }

        function populateCMASR2Interpretations({ scores, container }) {
            const interpTot = container.querySelector('#interp-tot');
            const interpFis = container.querySelector('#interp-fis');
            const interpInq = container.querySelector('#interp-inq');
            const interpSoc = container.querySelector('#interp-soc');
            
            if (interpTot) interpTot.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-2">Ansiedad Total (TOT) - T=${scores.tScores.tot}</h3><p class="text-gray-700">Esta puntuación es <strong class="${getClassification(scores.tScores.tot).color}">${getClassification(scores.tScores.tot).text.toLowerCase()}</strong>. Indica el nivel general de ansiedad manifiesta.</p>`;
            if (interpFis) interpFis.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-2">Ansiedad Fisiológica (FIS) - T=${scores.tScores.fis}</h3><p class="text-gray-700">Este resultado es <strong class="${getClassification(scores.tScores.fis).color}">${getClassification(scores.tScores.fis).text.toLowerCase()}</strong>. Sugiere cómo la ansiedad se manifiesta en el cuerpo (síntomas físicos).</p>`;
            if (interpInq) interpInq.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-2">Inquietud (INQ) - T=${scores.tScores.inq}</h3><p class="text-gray-700">Esta puntuación es <strong class="${getClassification(scores.tScores.inq).color}">${getClassification(scores.tScores.inq).text.toLowerCase()}</strong>. Refleja preocupaciones internas y nerviosismo.</p>`;
            if (interpSoc) interpSoc.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-2">Ansiedad Social (SOC) - T=${scores.tScores.soc}</h3><p class="text-gray-700">Esta puntuación es <strong class="${getClassification(scores.tScores.soc).color}">${getClassification(scores.tScores.soc).text.toLowerCase()}</strong>. Mide la ansiedad en situaciones sociales o de desempeño.</p>`;
        }
        function calculateCMASR2Scores() {
            const rawScores = { fis: 0, inq: 0, soc: 0, def: 0 };
            const test = tests.cmasr2;
            test.questions.forEach((q, index) => { const userAnswer = userAnswers[index]; if (q.reverse) { if (!userAnswer) rawScores[q.scale]++; } else { if (userAnswer) rawScores[q.scale]++; } });
            let incScore = 0;
            test.incPairs.forEach((pair, index) => { const ans1 = userAnswers[pair[0] - 1]; const ans2 = userAnswers[pair[1] - 1]; if (index === 8) { if (ans1 === ans2) incScore++; } else { if (ans1 !== ans2) incScore++; } });
            const tScores = { fis: 30 + (rawScores.fis * 3), inq: 30 + (rawScores.inq * 3), soc: 30 + (rawScores.soc * 3), def: 30 + (rawScores.def * 4) };
            tScores.tot = Math.round((tScores.fis + tScores.inq + tScores.soc) / 3);
            Object.keys(tScores).forEach(key => { if (tScores[key] > 80) tScores[key] = 80; if (tScores[key] < 20) tScores[key] = 20; });
            return { tScores, incScore };
        }
        function getClassification(score) { if (score > 70) return { text: 'Extremadamente Problemático', color: 'text-red-600' }; if (score > 60) return { text: 'Moderadamente Problemático', color: 'text-yellow-600' }; if (score >= 40) return { text: 'Promedio', color: 'text-green-600' }; return { text: 'Bajo / Menos Problemático', color: 'text-blue-600' }; }

        function calculateRosenbergScore() { let totalScore = 0; userAnswers.forEach((answerValue, index) => { const question = tests.rosenberg.questions[index]; if (question.positive) { totalScore += answerValue; } else { totalScore += (3 - answerValue); } }); return totalScore + 10; }

        function calculateSADSScore() { let score = 0; tests.sads.questions.forEach((q, index) => { if (userAnswers[index] === q.scoringKey) { score++; } }); return score; }

        function calculateBeckSISScore() { let score = 0; userAnswers.forEach(answer => { score += answer; }); return score; }
        
        window.viewReport = (report) => {
             individualReportContentEl.innerHTML = '';
             window.currentIndividualReport = report;
             
             const testKey = report.testKey;
             let content = generateReportContent(report);
             individualReportContentEl.innerHTML = content;
             
             if (testKey === 'cmasr2') {
                 populateCMASR2Interpretations({ scores: report.scores, container: individualReportContentEl });
                 const { tScores } = report.scores;
                 const scoreData = { labels: ['A. Fisiológica', 'Inquietud', 'A. Social', 'A. Total'], tScores: [tScores.fis, tScores.inq, tScores.soc, tScores.tot], ids: ['fis', 'inq', 'soc', 'tot'] };
                 const ctx = individualReportContentEl.querySelector('#resultsChart').getContext('2d');
                 if (chartInstance) chartInstance.destroy();
                 chartInstance = new Chart(ctx, { type: 'bar', data: { labels: scoreData.labels, datasets: [{ label: 'Puntuación T', data: scoreData.tScores, backgroundColor: scoreData.tScores.map(score => score > 70 ? 'rgba(239, 68, 68, 0.6)' : score > 60 ? 'rgba(251, 191, 36, 0.6)' : 'rgba(20, 184, 166, 0.6)'), borderColor: scoreData.tScores.map(score => score > 70 ? 'rgba(185, 28, 28, 1)' : score > 60 ? 'rgba(217, 119, 6, 1)' : 'rgba(13, 148, 136, 1)'), borderWidth: 2, borderRadius: 5 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 80, title: { display: true, text: 'Puntuación T' } } }, plugins: { legend: { display: false } } } });
             }
             
             showScreen(screens.individualReport);
        }

        async function registerReport() {
            if (!authReady) {
                showMessage('Error de Autenticación', 'La aplicación no está lista. Por favor, inténtalo de nuevo.', true);
                return;
            }

            registerBtn.textContent = 'Guardando...';
            registerBtn.disabled = true;

            const reportData = {
                student: studentData,
                testKey: currentTestKey,
                scores: testScores,
                timestamp: reportTimestamp,
                answers: JSON.stringify(userAnswers) 
            };
            
            try {
                const reportsCollectionRef = collection(db, `artifacts/${appId}/public/data/reports`);
                await addDoc(reportsCollectionRef, reportData);
                showMessage('Éxito', 'El reporte se ha registrado correctamente en la base de datos.');
            } catch (e) {
                console.error("Error al registrar el documento: ", e);
                showMessage('Error', 'No se pudo guardar el reporte. Por favor, inténtalo de nuevo.', true);
            } finally {
                registerBtn.textContent = 'Registrar Reporte';
                registerBtn.disabled = false;
            }
        }

        window.deleteReport = async (docId) => {
             if (!authReady) {
                 showMessage('Error de Autenticación', 'No tienes permiso para realizar esta acción.', true);
                 return;
             }

             // Eliminamos la confirmación para una eliminación directa
             // if (!confirm('¿Estás seguro de que quieres eliminar este reporte? Esta acción no se puede deshacer.')) {
             //     return;
             // }

             try {
                 const reportDocRef = doc(db, `artifacts/${appId}/public/data/reports`, docId);
                 await deleteDoc(reportDocRef);
                 showMessage('Reporte Eliminado', 'El reporte ha sido eliminado exitosamente.');
                 loadDashboardData();
             } catch (e) {
                 console.error("Error al eliminar el documento: ", e);
                 showMessage('Error', 'No se pudo eliminar el reporte. Por favor, inténtalo de nuevo.', true);
             }
        }

        async function loadDashboardData() {
            if (!db || !authReady) return;

            const grade = dashboardYearSelect.value + dashboardGroupSelect.value;
            const reportsCollectionRef = collection(db, `artifacts/${appId}/public/data/reports`);
            const q = query(reportsCollectionRef, where('student.grade', '==', grade));

            try {
                const querySnapshot = await getDocs(q);
                const reports = [];
                querySnapshot.forEach((doc) => {
                    reports.push({ id: doc.id, ...doc.data() });
                });
                updateDashboardChart(reports);
            } catch (error) {
                console.error("Error al cargar los datos del panel: ", error);
                showMessage('Error de Carga', 'No se pudieron cargar los datos del panel. Intenta de nuevo más tarde.', true);
            }
        }
        
        function updateDashboardChart(reports) {
            if (dashboardChartInstance) {
                dashboardChartInstance.destroy();
            }
            
            if (reports.length === 0) {
                dashboardNoDataEl.classList.remove('hidden');
                dashboardChartEl.classList.add('hidden');
                dashboardReportSummaryEl.classList.add('hidden');
                downloadDashboardBtn.classList.add('hidden');
                reportListEl.innerHTML = '';
                return;
            }

            dashboardNoDataEl.classList.add('hidden');
            dashboardChartEl.classList.remove('hidden');
            dashboardReportSummaryEl.classList.remove('hidden');
            downloadDashboardBtn.classList.remove('hidden');

            const testData = {};

            reports.forEach(report => {
                const test = report.testKey;
                if (!testData[test]) {
                    testData[test] = { totalScore: 0, count: 0, scores: [] };
                }
                const score = (test === 'cmasr2') ? report.scores.tScores.tot : report.scores.score;
                testData[test].scores.push(score);
                testData[test].totalScore += score;
                testData[test].count++;
            });
            
            const labels = Object.keys(testData).map(key => tests[key].title);
            const data = Object.keys(testData).map(key => testData[key].totalScore / testData[key].count);

            const maxScore = Math.max(...data);
            const maxIndex = data.indexOf(maxScore);
            const mostPrevalentTest = labels[maxIndex];
            mostPrevalentTestEl.textContent = mostPrevalentTest;


            const ctx = dashboardChartEl.getContext('2d');
            dashboardChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Puntuación Promedio del Grupo',
                        data: data,
                        backgroundColor: [
                            'rgba(20, 184, 166, 0.6)',
                            'rgba(99, 102, 241, 0.6)',
                            'rgba(244, 63, 94, 0.6)',
                            'rgba(100, 116, 139, 0.6)'
                        ],
                        borderColor: [
                            'rgba(13, 148, 136, 1)',
                            'rgba(79, 70, 229, 1)',
                            'rgba(190, 18, 60, 1)',
                            'rgba(51, 65, 85, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Puntuación Promedio'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: `Resultados Promedio para ${dashboardYearSelect.options[dashboardYearSelect.selectedIndex].text} - Grupo ${dashboardGroupSelect.value}`
                        }
                    }
                }
            });

            reportListEl.innerHTML = '';
            reports.forEach(report => {
                const li = document.createElement('li');
                const date = new Date(report.timestamp).toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short'});
                li.className = 'border-b last:border-b-0 py-2 hover:bg-gray-100 cursor-pointer report-list-item flex justify-between items-center';
                
                const reportSpan = document.createElement('span');
                reportSpan.className = 'flex-grow';
                reportSpan.innerHTML = `<strong>${report.student.name}</strong> - ${tests[report.testKey].title} (${date})`;
                reportSpan.addEventListener('click', () => window.viewReport(report));

                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-white bg-red-500 hover:bg-red-600 text-xs font-bold py-1 px-3 rounded-full ml-4';
                deleteButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                `;
                deleteButton.addEventListener('click', () => window.deleteReport(report.id));

                li.appendChild(reportSpan);
                li.appendChild(deleteButton);
                reportListEl.appendChild(li);
            });
        }
        
        window.downloadDashboardPDF = () => {
            const button = document.getElementById('download-dashboard-btn');
            button.textContent = 'Generando PDF...';
            button.disabled = true;

            html2canvas(dashboardReportContent, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const ratio = canvasWidth / canvasHeight;
                
                const imgWidth = pdfWidth - 40;
                let imgHeight = imgWidth / ratio;
                let heightLeft = imgHeight;
                let position = 20;

                pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 40);

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 40);
                }

                pdf.save(`Reporte_Grupo_${dashboardYearSelect.value}${dashboardGroupSelect.value}.pdf`);
                button.textContent = 'Descargar Gráficas (PDF)';
                button.disabled = false;
            });
        };

        window.downloadIndividualPDF = () => {
             if (!window.currentIndividualReport) return;

             const button = document.getElementById('download-individual-btn');
             button.textContent = 'Generando PDF...';
             button.disabled = true;

             const tempContainer = document.createElement('div');
             tempContainer.innerHTML = generateReportContent(window.currentIndividualReport);
             if (window.currentIndividualReport.testKey === 'cmasr2') {
                populateCMASR2Interpretations({ scores: window.currentIndividualReport.scores, container: tempContainer });
                const { tScores } = window.currentIndividualReport.scores;
                const scoreData = { labels: ['A. Fisiológica', 'Inquietud', 'A. Social', 'A. Total'], tScores: [tScores.fis, tScores.inq, tScores.soc, tScores.tot], ids: ['fis', 'inq', 'soc', 'tot'] };
                const ctx = tempContainer.querySelector('#resultsChart').getContext('2d');
                new Chart(ctx, { type: 'bar', data: { labels: scoreData.labels, datasets: [{ label: 'Puntuación T', data: scoreData.tScores, backgroundColor: scoreData.tScores.map(score => score > 70 ? 'rgba(239, 68, 68, 0.6)' : score > 60 ? 'rgba(251, 191, 36, 0.6)' : 'rgba(20, 184, 166, 0.6)'), borderColor: scoreData.tScores.map(score => score > 70 ? 'rgba(185, 28, 28, 1)' : score > 60 ? 'rgba(217, 119, 6, 1)' : 'rgba(13, 148, 136, 1)'), borderWidth: 2, borderRadius: 5 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 80, title: { display: true, text: 'Puntuación T' } } }, plugins: { legend: { display: false } } } });
             }

             document.body.appendChild(tempContainer);

             html2canvas(tempContainer, { scale: 2, useCORS: true }).then(canvas => {
                 const imgData = canvas.toDataURL('image/png');
                 const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                 const pdfWidth = pdf.internal.pageSize.getWidth();
                 const pdfHeight = pdf.internal.pageSize.getHeight();
                 const canvasWidth = canvas.width;
                 const canvasHeight = canvas.height;
                 const ratio = canvasWidth / canvasHeight;
                 
                 const imgWidth = pdfWidth - 40;
                 let imgHeight = imgWidth / ratio;
                 let heightLeft = imgHeight;
                 let position = 20;

                 pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
                 heightLeft -= (pdfHeight - 40);

                 while (heightLeft > 0) {
                     position = heightLeft - imgHeight;
                     pdf.addPage();
                     pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
                     heightLeft -= (pdfHeight - 40);
                 }

                 pdf.save(`Reporte_${window.currentIndividualReport.student.name.replace(/\s/g, '_')}.pdf`);
                 button.textContent = 'Descargar Informe (PDF)';
                 button.disabled = false;
                 document.body.removeChild(tempContainer);
             });
        };

        window.downloadPDF = () => {
            const button = document.getElementById('download-btn');
            button.textContent = 'Generando PDF...';
            button.disabled = true;

            html2canvas(reportContent, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const ratio = canvasWidth / canvasHeight;
                
                const imgWidth = pdfWidth - 40;
                let imgHeight = imgWidth / ratio;
                let heightLeft = imgHeight;
                let position = 20;

                pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 40);

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 40);
                }

                pdf.save(`Reporte_${currentTestKey.toUpperCase()}.pdf`);
                button.textContent = 'Descargar Informe (PDF)';
                button.disabled = false;
            });
        };

        registerBtn.addEventListener('click', registerReport);
        openDashboardBtn.addEventListener('click', () => {
            showScreen(screens.dashboard);
            loadDashboardData();
        });
        backFromDashboardBtn.addEventListener('click', () => showScreen(screens.studentInfo));
        backToDashboardBtn.addEventListener('click', () => showScreen(screens.dashboard));
        dashboardYearSelect.addEventListener('change', loadDashboardData);
        dashboardGroupSelect.addEventListener('change', loadDashboardData);
        downloadDashboardBtn.addEventListener('click', window.downloadDashboardPDF);
        downloadIndividualBtn.addEventListener('click', window.downloadIndividualPDF);

        toggleReportListBtn.addEventListener('click', () => {
             reportListEl.classList.toggle('hidden');
             if (reportListEl.classList.contains('hidden')) {
                 toggleIcon.style.transform = 'rotate(0deg)';
             } else {
                 toggleIcon.style.transform = 'rotate(180deg)';
             }
        });

        restartBtn.addEventListener('click', () => {
            document.getElementById('student-name').value = '';
            document.getElementById('student-age').value = '';
            document.getElementById('student-grade').value = '';
            showScreen(screens.studentInfo);
        });
        downloadBtn.addEventListener('click', window.downloadPDF);
        continueBtn.addEventListener('click', saveStudentInfoAndProceed);
        
        window.addEventListener('DOMContentLoaded', () => {
             showScreen(screens.studentInfo);
        });

    </script>
</body>
</html>
